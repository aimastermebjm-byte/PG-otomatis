<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopPWA - Harga Realistis</title>
    <meta name="theme-color" content="#3B82F6">
    <meta name="description" content="Progressive Web App - Harga Terjangkau">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .payment-success { animation: successPulse 0.6s ease-out; }
        @keyframes successPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .countdown { font-variant-numeric: tabular-nums; }
        .loading-dots::after { content: ''; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
        .install-prompt { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 24px; font-weight: 600; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 1000; cursor: pointer; transition: all 0.3s ease; }
        .install-prompt:hover { transform: translateX(-50%) translateY(-2px); box-shadow: 0 6px 25px rgba(0,0,0,0.3); }
        .debug-info { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 9999; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="debug-info" id="debug-info">Loading...</div>
    <div id="install-prompt" class="install-prompt hidden">üì± Install ShopPWA</div>
    <div id="app" class="max-w-md mx-auto h-screen flex flex-col">
        <header class="bg-blue-600 text-white p-4 shadow-lg">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold">ShopPWA</h1>
                <div class="flex items-center gap-3">
                    <button id="toggle-cart-btn" class="relative">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                    <button id="show-orders-btn">
                        <i data-lucide="package" class="w-5 h-5"></i>
                    </button>
                    <button id="toggle-auth-btn">
                        <i data-lucide="user" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-y-auto pb-20">
            <section id="auth-section" class="p-4">
                <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl p-6 text-white mb-4">
                    <h2 class="text-xl font-bold mb-2">Selamat Datang! üëã</h2>
                    <p class="text-sm mb-4 opacity-90">Login untuk pengalaman berbelanja terbaik</p>
                    <div class="space-y-3">
                        <input type="email" id="login-email" placeholder="Email" class="w-full p-3 rounded-lg text-gray-800">
                        <input type="password" id="login-password" placeholder="Password" class="w-full p-3 rounded-lg text-gray-800">
                        <button id="login-btn" class="w-full bg-white text-blue-600 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">Login</button>
                        <button id="register-btn" class="w-full bg-white/20 text-white py-3 rounded-lg font-semibold hover:bg-white/30 transition">Daftar</button>
                    </div>
                </div>
            </section>
            <section id="products-section" class="hidden p-4">
                <h2 class="text-lg font-semibold mb-4">Produk</h2>
                <div id="products" class="grid grid-cols-2 gap-3"></div>
            </section>
            <section id="cart-section" class="hidden p-4">
                <h2 class="text-lg font-semibold mb-4">Keranjang</h2>
                <div id="cart-items" class="space-y-3 mb-4"></div>
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between mb-3">
                        <span class="font-semibold">Total:</span>
                        <span id="cart-total" class="text-xl font-bold text-blue-600">Rp 0</span>
                    </div>
                    <button id="checkout-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">Checkout</button>
                </div>
            </section>
            <section id="checkout-section" class="hidden p-4">
                <h2 class="text-lg font-semibold mb-4">Checkout</h2>
                <div class="bg-white rounded-lg p-4 shadow-sm mb-4">
                    <h3 class="font-semibold mb-3">Ringkasan Pesanan</h3>
                    <div id="order-summary" class="space-y-2 mb-3"></div>
                    <div class="border-t pt-3">
                        <div class="flex justify-between mb-2"><span>Subtotal:</span><span id="subtotal">Rp 0</span></div>
                        <div class="flex justify-between mb-2"><span>Unique Code:</span><span id="unique-code" class="font-bold text-blue-600">000</span></div>
                        <div class="flex justify-between font-bold text-lg"><span>Total Transfer:</span><span id="total-transfer" class="text-blue-600">Rp 0</span></div>
                    </div>
                </div>
                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold mb-3">Instruksi Pembayaran</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>Bank:</span><span class="font-semibold">BCA</span></div>
                        <div class="flex justify-between"><span>No. Rekening:</span><span class="font-semibold">8870-1234-5678</span></div>
                        <div class="flex justify-between"><span>A.n:</span><span class="font-semibold">PT ShopPWA</span></div>
                        <div class="flex justify-between"><span>Jumlah:</span><span id="payment-amount" class="font-bold text-blue-600">Rp 0</span></div>
                    </div>
                    <button id="copy-details-btn" class="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold">üìã Salin Detail Pembayaran</button>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold mb-2 text-yellow-800">‚è∞ Batas Pembayaran</h3>
                    <div class="text-center"><div id="countdown" class="text-2xl font-bold text-yellow-800 countdown">10:00</div><p class="text-sm text-yellow-700">Pembayaran akan dibatalkan otomatis</p></div>
                </div>
                <button id="simulate-payment-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">üí∞ Simulasi Pembayaran (Testing)</button>
            </section>
            <section id="payment-section" class="hidden p-4">
                <div class="bg-white rounded-lg p-6 shadow-sm text-center">
                    <div id="payment-waiting" class="hidden">
                        <div class="w-20 h-20 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center"><i data-lucide="clock" class="w-10 h-10 text-blue-600"></i></div>
                        <h3 class="text-lg font-semibold mb-2">Menunggu Pembayaran</h3>
                        <p class="text-gray-600 mb-4">Transfer sesuai jumlah yang tertera</p>
                        <div class="text-sm text-gray-500"><p>System akan otomatis memverifikasi</p><p>setelah notifikasi bank masuk</p></div>
                        <div class="mt-4"><div class="loading-dots text-blue-600">Memeriksa status</div></div>
                    </div>
                    <div id="payment-success" class="hidden payment-success">
                        <div class="w-20 h-20 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center"><i data-lucide="check-circle" class="w-10 h-10 text-green-600"></i></div>
                        <h3 class="text-lg font-semibold mb-2 text-green-600">Pembayaran Berhasil!</h3>
                        <p class="text-gray-600 mb-4">Pesanan Anda telah dikonfirmasi</p>
                        <div class="bg-gray-50 rounded-lg p-3 mb-4"><p class="text-sm font-semibold">Order ID: <span id="order-id">#ORD-001</span></p><p class="text-sm">Status: <span class="text-green-600 font-semibold">PAID</span></p></div>
                        <button id="reset-shop-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold">Belanja Lagi</button>
                    </div>
                </div>
            </section>
            <section id="orders-section" class="hidden p-4">
                <h2 class="text-lg font-semibold mb-4">Riwayat Pesanan</h2>
                <div id="orders-list" class="space-y-3"></div>
            </section>
        </main>
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 max-w-md mx-auto">
            <div class="flex justify-around py-2">
                <button id="nav-home-btn" class="flex flex-col items-center p-2 text-blue-600"><i data-lucide="home" class="w-5 h-5"></i><span class="text-xs mt-1">Beranda</span></button>
                <button id="nav-cart-btn" class="flex flex-col items-center p-2 text-gray-400"><i data-lucide="shopping-cart" class="w-5 h-5"></i><span class="text-xs mt-1">Keranjang</span></button>
                <button id="nav-orders-btn" class="flex flex-col items-center p-2 text-gray-400"><i data-lucide="package" class="w-5 h-5"></i><span class="text-xs mt-1">Pesanan</span></button>
            </div>
        </nav>
        <div id="toast" class="hidden fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg z-50">
            <span id="toast-message"></span>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("EVENT: DOM Content Loaded. App is starting.");

        // --- KONFIGURASI & VARIABEL GLOBAL ---
        const SUPABASE_URL = "https://kvvciuedziljwpldduqp.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2dmNpdWVkemlsandwbGRkdXFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NTIxNzQsImV4cCI6MjA3NTEyODE3NH0.ENuhSVCxCNaudwQ3nO20jXx-n9gCgNKtI0miPzP8eRc";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("SCRIPT: Supabase client created.");

        let cart = [];
        let orders = [];
        let currentOrder = null;
        let currentUser = null;
        let countdownInterval = null;

        const products = [
            {id: 1, name: "Snack Pack", price: 12000, image: "üçø"}, {id: 2, name: "Minuman Soda", price: 10000, image: "ü•§"},
            {id: 3, name: "Coklat Bar", price: 15000, image: "üç´"}, {id: 4, name: "Kerupung", price: 8000, image: "ü•®"},
            {id: 5, name: "Permen", price: 5000, image: "üç¨"}, {id: 6, name: "Es Krim", price: 10000, image: "üç¶"},
            {id: 7, name: "Kue Tart", price: 15000, image: "üç∞"}, {id: 8, name: "Jus Buah", price: 12000, image: "üßÉ"}
        ];

        // --- FUNGSI-FUNGSI HELPER ---
        function updateDebug(message) { const debugInfo = document.getElementById('debug-info'); if(debugInfo) debugInfo.textContent = message; }
        function showToast(message) { const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); if(toast && toastMessage) { toastMessage.textContent = message; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 3000); } }
        function hideAllSections() { const sections = ['auth-section', 'products-section', 'cart-section', 'checkout-section', 'payment-section', 'orders-section']; sections.forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); }); }
        function updateNavigation(active) {
            const buttons = document.querySelectorAll('nav button');
            buttons.forEach(button => {
                const icon = button.querySelector('svg'); const text = button.querySelector('span');
                if (icon && text) {
                    icon.classList.remove('text-blue-600'); icon.classList.add('text-gray-400');
                    if (active === 'home' && text.textContent === 'Beranda') { icon.classList.remove('text-gray-400'); icon.classList.add('text-blue-600'); }
                    else if (active === 'cart' && text.textContent === 'Keranjang') { icon.classList.remove('text-gray-400'); icon.classList.add('text-blue-600'); }
                    else if (active === 'orders' && text.textContent === 'Pesanan') { icon.classList.remove('text-gray-400'); icon.classList.add('text-blue-600'); }
                }
            });
            const authBtn = document.getElementById('toggle-auth-btn'); if(authBtn) { const authIcon = authBtn.querySelector('i'); if(authIcon) { if (currentUser) { authIcon.classList.remove('text-gray-400'); authIcon.classList.add('text-blue-600'); } else { authIcon.classList.remove('text-blue-600'); authIcon.classList.add('text-gray-400'); } } }
            // Reset semua nav buttons kecuali yang dipilih
            if (active !== 'checkout' && active !== 'payment') {
                const buttons = document.querySelectorAll('nav button');
                buttons.forEach(button => {
                    const icon = button.querySelector('svg');
                    if (icon) {
                        icon.classList.remove('text-blue-600');
                        icon.classList.add('text-gray-400');
                    }
                });
            }
        }
        function updateCartCount() { const count = cart.reduce((sum, item) => sum + item.quantity, 0); const cartCountElement = document.getElementById('cart-count'); if(cartCountElement) cartCountElement.textContent = count; }
        
        // --- FUNGSI AUTH ---
        async function checkUserSession() {
            updateDebug('Checking for existing session...');
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                updateDebug('Existing session found for: ' + currentUser.email);
                showProducts();
            } else {
                updateDebug('No existing session. Showing login.');
                showAuth();
            }
        }
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) { showToast('Email dan password harus diisi'); return; }
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                currentUser = data.user;
                showToast('Login berhasil!');
                updateDebug('User logged in: ' + currentUser.email);
                showProducts();
            } catch (error) { showToast('Login gagal: ' + error.message); updateDebug('Login error: ' + error.message); }
        }
        async function register() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) { showToast('Email dan password harus diisi'); return; }
            try {
                const { data, error } = await supabaseClient.auth.signUp({ email, password });
                if (error) throw error;
                showToast('Registrasi berhasil! Silakan cek email untuk verifikasi.');
                updateDebug('User registered: ' + data.user.email);
            } catch (error) { showToast('Registrasi gagal: ' + error.message); updateDebug('Register error: ' + error.message); }
        }
        async function logout() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) { showToast('Logout gagal: ' + error.message); } else { 
                currentUser = null;
                showToast('Logout berhasil!');
                showAuth();
            }
        }
        function toggleAuth() { if (currentUser) { logout(); } else { showAuth(); } }
        function showAuth() { hideAllSections(); const authSection = document.getElementById('auth-section'); if(authSection) authSection.classList.remove('hidden'); updateNavigation(); }
        function showProducts() { hideAllSections(); const productsSection = document.getElementById('products-section'); if(productsSection) productsSection.classList.remove('hidden'); updateNavigation('home'); }
        function showCart() { hideAllSections(); const cartSection = document.getElementById('cart-section'); if(cartSection) cartSection.classList.remove('hidden'); loadCartItems(); updateNavigation('cart'); }
        function showOrders() { if (!currentUser) { showToast('Silakan login terlebih dahulu'); return; } hideAllSections(); const ordersSection = document.getElementById('orders-section'); if(ordersSection) ordersSection.classList.remove('hidden'); updateNavigation('orders'); loadOrders(); }

        // --- FUNGSI PRODUK & CART ---
        function loadProducts() {
            const container = document.getElementById('products');
            if(container) {
                container.innerHTML = products.map(p => `
                    <div class="bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition">
                        <div class="text-4xl mb-2 text-center">${p.image}</div>
                        <h3 class="font-medium text-sm mb-1">${p.name}</h3>
                        <p class="text-blue-600 font-bold text-sm mb-2">Rp ${p.price.toLocaleString('id-ID')}</p>
                        <button data-product-id="${p.id}" class="add-to-cart-btn w-full bg-blue-600 text-white py-2 rounded text-sm hover:bg-blue-700 transition">+ Keranjang</button>
                    </div>
                `).join('');
            }
        }
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) { existingItem.quantity++; } else { cart.push({...product, quantity: 1}); }
            updateCartCount(); showToast(`${product.name} ditambahkan ke keranjang`);
        }
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (item) { item.quantity += change; if (item.quantity <= 0) { cart = cart.filter(item => item.id !== productId); } loadCartItems(); updateCartCount(); }
        }
        function loadCartItems() {
            const container = document.getElementById('cart-items');
            if (cart.length === 0) { container.innerHTML = '<p class="text-center text-gray-500 py-8">Keranjang kosong</p>'; const cartTotal = document.getElementById('cart-total'); if(cartTotal) cartTotal.textContent = 'Rp 0'; return; }
            container.innerHTML = cart.map(item => `
                <div class="bg-white rounded-lg p-3 shadow-sm flex items-center">
                    <div class="text-2xl mr-3">${item.image}</div>
                    <div class="flex-1"><h4 class="font-medium text-sm">${item.name}</h4><p class="text-blue-600 font-bold text-sm">Rp ${item.price.toLocaleString('id-ID')}</p></div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateQuantity(${item.id}, -1)" class="w-6 h-6 bg-gray-200 rounded flex items-center justify-center">-</button>
                        <span class="text-sm font-medium">${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, 1)" class="w-6 h-6 bg-gray-200 rounded flex items-center justify-center">+</button>
                    </div>
                </div>
            `).join('');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const cartTotal = document.getElementById('cart-total'); if(cartTotal) cartTotal.textContent = `Rp ${total.toLocaleString('id-ID')}`;
        }

        // --- FUNGSI CHECKOUT & ORDERS ---
        async function checkout() {
            if (cart.length === 0) return;
            if (!currentUser) { showToast('Anda harus login terlebih dahulu.'); return; }
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const uniqueCode = Math.floor(Math.random() * 1000);
            const total = subtotal + uniqueCode;
            const orderData = {
                userid: currentUser.id,
                userEmail: currentUser.email,
                items: cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    image: item.image,
                    quantity: item.quantity
                })),
                subtotal: subtotal,
                uniqueCode: uniqueCode,
                total: total,
                status: 'PENDING',
                created_at: new Date().toISOString()
            };
            try {
                const { data, error } = await supabaseClient.from('orders').insert([orderData]).select();
                if (error) throw error;
                showToast('Pesanan berhasil dibuat!'); updateDebug('Order created with ID: ' + data[0].id);
                const orderSummary = document.getElementById('order-summary'); if(orderSummary) orderSummary.innerHTML = cart.map(item => `<div class="flex justify-between text-sm"><span>${item.name} x${item.quantity}</span><span>Rp ${(item.price * item.quantity).toLocaleString('id-ID')}</span></div>`).join('');
                const subtotalEl = document.getElementById('subtotal'); if(subtotalEl) subtotalEl.textContent = `Rp ${subtotal.toLocaleString('id-ID')}`;
                const uniqueCodeEl = document.getElementById('unique-code'); if(uniqueCodeEl) uniqueCodeEl.textContent = uniqueCode.toString().padStart(3, '0');
                const totalTransferEl = document.getElementById('total-transfer'); if(totalTransferEl) totalTransferEl.textContent = `Rp ${total.toLocaleString('id-ID')}`;
                const paymentAmountEl = document.getElementById('payment-amount'); if(paymentAmountEl) paymentAmountEl.textContent = `Rp ${total.toLocaleString('id-ID')}`;
                currentOrder = { ...orderData, id: data[0].id };
                hideAllSections(); const checkoutSection = document.getElementById('checkout-section'); if(checkoutSection) checkoutSection.classList.remove('hidden'); updateNavigation('checkout');
                startCountdown();
            } catch (error) {
                console.error('Checkout error detail:', error);
                updateDebug('Checkout error: ' + error.message);

                // Tampilkan error yang lebih user-friendly
                if (error.message.includes('duplicate key')) {
                    showToast('Terjadi kesalahan, silakan coba lagi.');
                } else if (error.message.includes('permission')) {
                    showToast('Anda tidak memiliki izin untuk melakukan checkout.');
                } else {
                    showToast('Checkout gagal: ' + error.message);
                }
            }
        }
        function startCountdown() {
            let timeLeft = 600; // 10 menit dalam detik
            const countdownEl = document.getElementById('countdown');
            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                if (countdownEl) countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    showToast('‚è∞ Batas pembayaran habis! Pesanan dibatalkan.');
                    cancelOrder();
                }
                timeLeft--;
            }, 1000);
        }
        async function cancelOrder() {
            if (currentOrder) {
                try {
                    // Update status order di Supabase
                    await supabaseClient.from('orders').update({ status: 'CANCELLED' }).eq('id', currentOrder.id);
                    updateDebug('Order cancelled due to timeout: ' + currentOrder.id);
                } catch (error) {
                    console.error('Error cancelling order:', error);
                }
                currentOrder = null;
            }
            cart = [];
            updateCartCount();
            showProducts();
        }
        async function loadOrders() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabaseClient.from('orders').select('*').eq('userid', currentUser.id).order('created_at', { ascending: false });
                if (error) throw error;
                orders = data; displayOrders(); updateDebug('Orders loaded from Supabase: ' + orders.length);
            } catch (error) { showToast('Gagal memuat pesanan: ' + error.message); updateDebug('Load orders error: ' + error.message); }
        }
        function displayOrders() {
            const container = document.getElementById('orders-list');
            if (orders.length === 0) { container.innerHTML = '<p class="text-center text-gray-500 py-8">Belum ada pesanan</p>'; return; }
            container.innerHTML = orders.map(order => `
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <div><p class="font-semibold text-sm">#${order.id.substring(0, 8)}</p><p class="text-xs text-gray-500">${order.created_at ? new Date(order.created_at).toLocaleString('id-ID') : 'N/A'}</p></div>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${order.status === 'PAID' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'}">${order.status}</span>
                    </div>
                    <div class="flex justify-between"><span class="text-sm text-gray-600">${order.items.length} item</span><span class="font-bold text-sm">Rp ${order.total.toLocaleString('id-ID')}</span></div>
                </div>
            `).join('');
        }
        function simulatePayment() {
            if (!currentOrder) return;
            showToast('Mensimulasikan notifikasi bank...');
            setTimeout(async () => {
                try {
                    const response = await fetch('https://kvvciuedziljwpldduqp.supabase.co/functions/v1/verify-payment', {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_ANON_KEY },
                        body: JSON.stringify({ amount: currentOrder.total, senderName: 'TEST SIMULATION', rawNotification: 'Simulasi pembayaran' })
                    });
                    const result = await response.json();
                    if (response.ok) { showToast('‚úÖ Pembayaran berhasil diverifikasi otomatis!'); showPaymentSuccess(currentOrder); loadOrders(); }
                    else { showToast('Gagal verifikasi: ' + result.message); }
                } catch (error) { showToast('Terjadi kesalahan.'); console.error(error); }
            }, 2000);
        }
        function showPaymentSuccess(order) {
            hideAllSections(); const paymentSection = document.getElementById('payment-section'); if(paymentSection) paymentSection.classList.remove('hidden');
            const waitingDiv = document.getElementById('payment-waiting'); if(waitingDiv) waitingDiv.classList.add('hidden');
            const successDiv = document.getElementById('payment-success'); if(successDiv) successDiv.classList.remove('hidden');
            const orderIdEl = document.getElementById('order-id'); if(orderIdEl) orderIdEl.textContent = `#${order.id.substring(0, 8)}`;
            cart = []; currentOrder = null; updateCartCount();
            if (countdownInterval) clearInterval(countdownInterval);
        }

        // --- INISIALISASI & EVENT LISTENERS ---
        async function initializeApp() {
            updateDebug('Initializing app...');
            lucide.createIcons();
            await checkUserSession();
            loadProducts();
            updateCartCount();
            document.getElementById('login-btn')?.addEventListener('click', login);
            document.getElementById('register-btn')?.addEventListener('click', register);
            document.getElementById('toggle-auth-btn')?.addEventListener('click', toggleAuth);
            document.getElementById('show-orders-btn')?.addEventListener('click', showOrders);
            document.getElementById('nav-home-btn')?.addEventListener('click', showProducts);
            document.getElementById('nav-cart-btn')?.addEventListener('click', showCart);
            document.getElementById('nav-orders-btn')?.addEventListener('click', showOrders);
            document.getElementById('checkout-btn')?.addEventListener('click', checkout);
            document.getElementById('copy-details-btn')?.addEventListener('click', () => {
                const bank = "BCA\n8870-1234-5678\nPT ShopPWA\n" + document.getElementById('payment-amount').textContent;
                navigator.clipboard.writeText(bank).then(() => showToast('Detail pembayaran disalin!'));
            });
            document.getElementById('simulate-payment-btn')?.addEventListener('click', simulatePayment);
            document.getElementById('reset-shop-btn')?.addEventListener('click', () => { showProducts(); cart = []; updateCartCount(); });
            document.getElementById('products')?.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    const productId = parseInt(e.target.dataset.productId);
                    addToCart(productId);
                }
            });
            updateDebug('App initialized and listeners attached.');
        }
        initializeApp();
    });
    </script>
</body>
</html>